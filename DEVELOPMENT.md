# Development

Based upon [these](https://github.com/microsoft/azure-devops-extension-hot-reload-and-debug) and [these](https://devblogs.microsoft.com/devops/streamlining-azure-devops-extension-development/) instructions.

* [Visual Studio Code](https://code.visualstudio.com/)
* [Mozilla Firefox](https://www.mozilla.org/pl/firefox/) (because Visual Studio Code Debugger for Chrome extension [doesn't support IFrames](https://github.com/microsoft/vscode-chrome-debug/issues/786))
* [Debugger for Firefox Visual Studio Code extension](https://marketplace.visualstudio.com/items?itemName=firefox-devtools.vscode-firefox-debug)
* [Node.js](https://nodejs.org) and some packages:
  * [tfx-cli](https://www.npmjs.com/package/tfx-cli) `npm install -g tfx-cli`
  * [webpack](https://www.npmjs.com/package/webpack) `npm install -g webpack`
  * [webpack-dev-server](https://www.npmjs.com/package/webpack-dev-server) `npm install -g webpack-dev-server`

## Setting up local development environment

### How it works

A local environment consists only of webpack development web server where compiled extension is hosted, a web browser and IDE. Installing a whole local instance of VSTS or Azure DevOps is not required. All of it just works only because development versions of extensions contain references to resources hosted on a local web server.

More importantly, they support hot reloading and all changes are applied immediately, without reinstalling or relaunching the server.

### First time setup: publishing and configuring the extension

Go to your [Azure DevOps](https://dev.azure.com/) organization, then generate a new [Azure DevOps Personal Access Token](https://dev.azure.com/mardz/_usersSettings/tokens). Make sure that your token has its access set to **All accessible organizations** and is within **Marketplace (Publish)** scope as well. More information on Personal Access Tokens is available [here](https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops).

Now you're ready to publish your development extension. Log in into your Azure DevOps organization using `tfx login` command where you will be asked to authenticate in keyboard-interactive mode.

``` console
$ tfx login

TFS Cross Platform Command Line Interface v0.7.9
Copyright Microsoft Corporation
> Service URL: https://dev.azure.com/<your account name>
> Personal access token: <token>
Logged in successfully
```

Now you're able to deploy your extension for the first time.

``` console
$ tfx extension publish --manifest-globs vss-extension.json --overrides-file configs/dev.json --token <token>

TFS Cross Platform Command Line Interface v0.7.9
Copyright Microsoft Corporation
Checking if this extension is already published
It isn't, create a new extension.

== Extension Validation In Progress ==
This should take only a few seconds, but in some cases may take a bit longer. You can choose to exit (Ctrl-C) if you don't want to wait. To get the validation status, you may run the command below. If you don't want TFX to wait for validation, use the --no-wait-validation parameter. This extension will be available after validation is successful.

tfx extension isvalid --publisher mard --extension-id codenames-dev --version 0.0.1 --service-url https://marketplace.visualstudio.com/ --token <your PAT>

=== Completed operation: publish extension ===
 - Packaging: <path>\mard.codenames-dev-0.0.1.vsix
 - Publishing: success
 - Sharing: not shared (use --share-with to share)
```

Navigate to your [Marketplace publishing management page](https://marketplace.visualstudio.com/manage/publishers).

Right click on your development extension and share it within your organization (alternatively, you can publish your extension with --share-with parameter as indicated above).

Right click on your development extension and click *View Extension*, click *Get it free* button and proceed with the instructions to install it within your organization.

In [your Azure DevOps organization](https://dev.azure.com), click *Organization settings* on bottom left of your screen. Go to *Process*, and add the control to the desired work item types.

### Compile, launch and debug

First, run `npm install` to install required node modules.

After you `npm run compile` 'd your project, you can run the local development web server with your compiled extension with `webpack-dev-server --mode development` command. You can also run `npm run start:dev` to do both things at the same time.

Start `Launch Firefox` debug profile in Visual Studio Code. You will be shown `https://localhost:3000/` development server root page, where you'll need to accept the security exception for the certificate generated by the local server.

You're all set. Log in to the DevOps organization where you configured installed the extension and you're ready to debug.

## Gotchas & Caveats

* You may need to override id and publisher of your extension.
* Extenion manifest is taken from the installed extension, not from local environment. That means if you're relying on local development, you need to publish your extension every time you make breaking changes to your manifest, such as paths in contribution properties.
